<html>
  <head><title>xmas.web</title></head>
  <body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      "use strict";

      function Light(color) {
        this.enabled = false;
        this.color = color;
      }

      var lightArray = [
        new Light("Red"),
        new Light("Orange"),
        new Light("Yellow"),
        new Light("Green"),
        new Light("Blue"),
        new Light("Indigo"),
        new Light("Violet"),
        new Light("Red")
      ];

      var keyMap = {
        "q": 0,
        "w": 1,
        "e": 2,
        "r": 3,
        "t": 4,
        "y": 5,
        "u": 6,
        "i": 7
      };

      function setLightStateFromBitField(bitfield) {
        for (var i = 0; i < lightArray.length; i++) {
          lightArray[i].enabled = bitfield & 1;
          bitfield >>= 1;
        }
      }

      function showLightStatus() {
        for (var i = 0; i < lightArray.length; i++) {
          var element = document.getElementById('toggle' + i);
          element.style.background = lightArray[i].enabled ? lightArray[i].color : "Gray";
        }
      }

      var serverName = 'http://' + location.host
      var socket = io.connect(serverName);
      socket.on('server update', function(data) {
	setLightStateFromBitField(data);
        showLightStatus();
      });

      function toggleLight(index) {
        if (lightArray[index].enabled)
          socket.emit('light disable', index);
        else
          socket.emit('light enable', index);
      }

      function clicked(index) {
        toggleLight(index);
      }

      function keyPressHandler(event) {
        var index = keyMap[String.fromCharCode(event.charCode).toLowerCase()];
        toggleLight(index);
      }
      document.onkeypress = keyPressHandler;
    </script>
    <h1>xmas.js</h1>
    <div>
      <div id="toggle0" style="width:150px; height:150px; background:gray; float: left" onclick="clicked(0)"></div>
      <div id="toggle1" style="width:150px; height:150px; background:gray; float: left" onclick="clicked(1)"></div>
      <div id="toggle2" style="width:150px; height:150px; background:gray; float: left" onclick="clicked(2)"></div>
      <div id="toggle3" style="width:150px; height:150px; background:gray; float: left" onclick="clicked(3)"></div>
      <div id="toggle4" style="width:150px; height:150px; background:gray; float: left" onclick="clicked(4)"></div>
      <div id="toggle5" style="width:150px; height:150px; background:gray; float: left" onclick="clicked(5)"></div>
      <div id="toggle6" style="width:150px; height:150px; background:gray; float: left" onclick="clicked(6)"></div>
      <div id="toggle7" style="width:150px; height:150px; background:gray; float: left" onclick="clicked(7)"></div>
    </div>
  </body>
</html>
